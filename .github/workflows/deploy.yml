name: Deploy Laravel Docker App to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Copy files to EC2
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: ${{ secrets.EC2_SSH_PORT || 22 }}
        source: "."
        target: ${{ secrets.EC2_APP_DIR || '/opt/laravel-app' }}
        strip_components: 0
        exclude:
          - ".git"
          - ".github"
          - "node_modules"
          - "vendor"
          - ".env"
          - "storage/logs/*"
          - "storage/framework/cache/*"
          - "storage/framework/sessions/*"
          - "storage/framework/views/*"

    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: ${{ secrets.EC2_SSH_PORT || 22 }}
        script: |
          set -e
          
          APP_DIR=${{ secrets.EC2_APP_DIR || '/opt/laravel-app' }}
          cd $APP_DIR
          
          # Create .env from .example.env if it doesn't exist
          if [ ! -f .env ]; then
            cp .example.env .env
          fi
          
          # Update database configuration in .env
          sed -i "s|^DB_CONNECTION=.*|DB_CONNECTION=${{ secrets.DB_CONNECTION || 'mysql' }}|" .env
          sed -i "s|^DB_HOST=.*|DB_HOST=${{ secrets.DB_HOST }}|" .env
          sed -i "s|^DB_PORT=.*|DB_PORT=${{ secrets.DB_PORT || '3306' }}|" .env
          sed -i "s|^DB_DATABASE=.*|DB_DATABASE=${{ secrets.DB_DATABASE }}|" .env
          sed -i "s|^DB_USERNAME=.*|DB_USERNAME=${{ secrets.DB_USERNAME }}|" .env
          sed -i "s|^DB_PASSWORD=.*|DB_PASSWORD=${{ secrets.DB_PASSWORD }}|" .env
          
          # Update app configuration
          sed -i "s|^APP_ENV=.*|APP_ENV=${{ secrets.APP_ENV || 'production' }}|" .env
          sed -i "s|^APP_DEBUG=.*|APP_DEBUG=${{ secrets.APP_DEBUG || 'true' }}|" .env
          if [ -n "${{ secrets.APP_URL }}" ]; then
            sed -i "s|^APP_URL=.*|APP_URL=${{ secrets.APP_URL }}|" .env
          fi
          
          # Build and start containers
          docker compose down || true
          docker compose up -d --build
          
          # Wait for containers to be ready
          sleep 15
          
          # Run Laravel commands inside the app container
          docker compose exec -T app php artisan config:clear
          docker compose exec -T app php artisan migrate --force
