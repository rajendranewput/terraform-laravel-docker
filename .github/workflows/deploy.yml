name: Deploy Laravel Docker App to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Build and push Docker image
      run: |
        docker build -t $ECR_REPOSITORY -f docker/php/Dockerfile .
        docker tag $ECR_REPOSITORY:latest \
          ${{ steps.login-ecr.outputs.registry }}/$ECR_REPOSITORY:latest
        docker push \
          ${{ steps.login-ecr.outputs.registry }}/$ECR_REPOSITORY:latest

    - name: Copy docker-compose.yml to EC2
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: ${{ secrets.EC2_SSH_PORT || 22 }}
        source: "docker-compose.yml"
        target: ${{ secrets.EC2_APP_DIR || '/home/ec2-user/app' }}

    - name: Copy nginx config to EC2
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: ${{ secrets.EC2_SSH_PORT || 22 }}
        source: "docker/nginx/default.conf"
        target: ${{ secrets.EC2_APP_DIR || '/home/ec2-user/app' }}/docker/nginx/

    - name: Copy Laravel public/ to EC2 (for nginx)
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: ${{ secrets.EC2_SSH_PORT || 22 }}
        source: "public"
        target: ${{ secrets.EC2_APP_DIR || '/home/ec2-user/app' }}

    - name: Copy .example.env to EC2
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: ${{ secrets.EC2_SSH_PORT || 22 }}
        source: ".example.env"
        target: ${{ secrets.EC2_APP_DIR || '/home/ec2-user/app' }}

    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: ${{ secrets.EC2_SSH_PORT || 22 }}
        script: |
          set -e

          APP_DIR="${{ secrets.EC2_APP_DIR }}"
          if [ -z "$APP_DIR" ]; then APP_DIR="/home/ec2-user/app"; fi

          mkdir -p "$APP_DIR/docker/nginx"
          cd "$APP_DIR"

          # Create .env from .example.env if missing, then set DB details
          if [ ! -f .env ]; then
            cp .example.env .env
          fi

          set_kv () {
            key="$1"
            value="$2"
            if grep -q "^${key}=" .env; then
              sed -i -E "s|^${key}=.*$|${key}=${value}|g" .env
            else
              printf "\n%s=%s\n" "$key" "$value" >> .env
            fi
          }

          set_kv "APP_ENV" "development"
          set_kv "APP_DEBUG" "true"
          set_kv "APP_URL" "http://13.201.31.170"
          set_kv "DB_HOST" "${{ secrets.DB_HOST }}"
          set_kv "DB_DATABASE" "${{ secrets.DB_DATABASE }}"
          set_kv "DB_USERNAME" "${{ secrets.DB_USERNAME }}"
          set_kv "DB_PASSWORD" "${{ secrets.DB_PASSWORD }}"

          AWS_REGION="${{ secrets.AWS_REGION }}"
          REGISTRY="${{ steps.login-ecr.outputs.registry }}"
          IMAGE="${{ secrets.ECR_REPOSITORY }}"
          export REGISTRY IMAGE

          aws ecr get-login-password --region "$AWS_REGION" | \
            docker login --username AWS --password-stdin "$REGISTRY"

          docker pull "$REGISTRY/$IMAGE:latest"

           # Prefer modern Docker Compose plugin ("docker compose"). Fallback to legacy "docker-compose" if installed.
           if docker compose version >/dev/null 2>&1; then
             COMPOSE="docker compose"
           elif command -v docker-compose >/dev/null 2>&1; then
             COMPOSE="docker-compose"
           else
             echo "ERROR: Docker Compose not found. Install docker compose plugin or docker-compose." >&2
             exit 1
           fi

           $COMPOSE down || true
           $COMPOSE up -d

          sleep 10
          docker exec laravel_app php artisan config:clear
          docker exec laravel_app php artisan migrate --force
